<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue-Fabric</title>
  <link rel="icon" href="./static/favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    #canvas-container {
      position: relative;
      border: 1px solid #ccc;
      overflow: hidden;
      height: 600px;
      background: url(../demo/static/draw-bg.png) left top no-repeat;
      background-size: 100% 100%;
    }

    .toolbar-top {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .toolbar-top button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar-top button:hover {
      background: #02a7f0;
      color: #fff;
      border-color: #02a7f0;
    }

    .toolbar-top input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 150px;
    }

    .toolbar-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar-row label {
      font-size: 14px;
      color: #666;
    }

    .info {
      margin-top: 15px;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      font-size: 14px;
      color: #666;
    }

    .mouse-position {
      position: fixed;
      top: 20px;
      right: 20px;
      color: #333;
      font-size: 14px;
      z-index: 100;
    }
  </style>
</head>

<body>
  <div class="toolbar-top">
    <div class="toolbar-row">
      <button onclick="board.setTool('select')">选择</button>
      <!-- <button onclick="addCustomText()">新增文字</button> -->
      <!-- <button onclick="addCustomImage()">新增图片</button> -->
      <!-- <button onclick="board.setTool('curve')">画曲线</button> -->
      <!-- <button onclick="board.undo()">撤销</button> -->
      <!-- <button onclick="board.redo()">还原</button> -->
      <!-- <button onclick="board.zoomIn()">放大</button> -->
      <!-- <button onclick="board.zoomOut()">缩小</button> -->
      <!-- <button onclick="board.resetZoom()">还原视图</button> -->
      <!-- <button onclick="board.toggleAreaHelpers()">显示/隐藏距离</button> -->
      <!-- <button onclick="toolbar.show()">显示工具栏</button> -->
      <!-- <button onclick="toolbar.hide()">隐藏工具栏</button> -->
      <!-- <button onclick="listCustomObjects()">列出对象</button> -->
    </div>
    <div class="toolbar-row">
      <button onclick="board.clear()">清空画布</button>
      <button onclick="exportCanvas()">导出JSON</button>
      <button onclick="document.getElementById('jsonFileInput').click()">导入JSON</button>
      <input type="file" id="jsonFileInput" accept=".json" onchange="handleJsonFileImport(event)" style="display:none">
      <!-- <button onclick="board.exportToImage()">下载图片</button> -->
    </div>
    <!-- <div class="toolbar-row">
      <label>修改文字:</label>
      <input type="text" id="textIdInput" placeholder="输入文字ID">
      <button onclick="updateTextByInput()">修改文字</button>
    </div> -->
    <!-- <div class="toolbar-row">
      <label>操作图片:</label>
      <input type="text" id="imageIdInput" placeholder="输入图片ID">
      <button onclick="rotateImageByInput()">旋转图片</button>
    </div> -->
    <!-- <div class="toolbar-row">
      <label>删除对象:</label>
      <input type="text" id="deleteIdInput" placeholder="输入要删除的ID">
      <button onclick="deleteByInput()">删除</button>
    </div> -->
    <!-- <div class="toolbar-row">
      <label>人员追踪:</label>
      <button onclick="createSinglePerson()">一次一人</button>
      <button onclick="createMultiplePersons()">一次多人</button>
      <button onclick="updatePersonPositions()">更新多人位置</button>
      <button onclick="showTraceDemo('line')">直线轨迹</button>
      <button onclick="showTraceDemo('curve')">曲线轨迹</button>
      <button onclick="clearPersons()">清除人员</button>
    </div> -->
    <!-- <div class="toolbar-row">
      <label>背景图:</label>
      <input type="text" id="bgImageInput" placeholder="输入图片URL或Base64">
      <select id="bgScaleMode">
        <option value="fill">填充 (fill)</option>
        <option value="fit">适应 (fit)</option>
        <option value="stretch">拉伸 (stretch)</option>
        <option value="center">居中 (center)</option>
      </select>
      <button onclick="setBackgroundImage()">设置背景</button>
      <button onclick="clearBackgroundImage()">清除背景</button>
      <input type="file" id="bgFileInput" accept="image/*" onchange="handleBgFileSelect(event)" style="display:none">
      <button onclick="document.getElementById('bgFileInput').click()">选择本地图片</button>
    </div> -->
  </div>

  <div id="canvas-container"></div>
  <div class="mouse-position" id="mousePosition">X: 0, Y: 0</div>

  <!-- <div class="info">
    <p>操作提示：</p>
    <ul>
      <li>绘制区域：点击添加点，靠近起始点闭合多边形</li>
      <li>曲线工具：点击添加控制点，按 Enter 完成，按 Escape 取消</li>
      <li>文字工具：点击画布添加文本</li>
      <li>缩放：滚轮缩放，Alt+拖动 或 鼠标中键拖动平移</li>
      <li>撤销：绘制时按 Ctrl+Z 撤销上一个点</li>
    </ul>
  </div> -->

  <link rel="stylesheet" href="/dist/style.css">
  <script src="/demo/static/fabric.js"></script>
  <script src="/dist/index.umd.js"></script>
  <script>
    const { FabricPaint, AreaTool, DragTool, SelectTool, RectTool, LineTool, TextTool, CurveTool, ImageTool, Toolbar } = VueFabric
    const container = document.getElementById('canvas-container')
    const board = new FabricPaint('#canvas-container', {
      width: container.clientWidth,
      height: container.clientHeight,
      // 按照实际像素点击内容
      // perPixelTargetFind: false,
      backgroundColor: 'transparent'
    }).init()

    board
      .registerTool('select', new SelectTool())
      .registerTool('line', new LineTool())
      .registerTool('area', new AreaTool())
      .registerTool('curve', new CurveTool())
      .registerTool('rect', new RectTool())
      .registerTool('text', new TextTool({
        fill: '#0000BF'
      }))
      .registerTool('image', new ImageTool())
      .registerTool('drag', new DragTool())
      .setTool('select')

    const toolbar = new Toolbar(board, {
      // tools: ['select', 'rect', 'undo', 'redo', 'helpers'],
      tools: ['lineColor', 'fillColor', 'drag', 'select', 'line', 'area', 'rect', 'curve', 'image', 'helpers', 'undo', 'redo'],
      visible: true
    }).init()

    // 监听鼠标移动事件，实时显示坐标
    const mousePositionEl = document.getElementById('mousePosition')
    board.on('mouse:move', (data) => {
      mousePositionEl.textContent = `X: ${data.x}, Y: ${data.y}`
    })

    board.on('line:created', (data) => {
      console.log('直线已创建:', data)
    })

    board.on('line:selected', (data) => {
      console.log('直线已选中:', data)
    })

    board.on('area:created', (data) => {
      console.log('区域已创建:', data)
    })

    board.on('area:selected', (data) => {
      console.log('区域已选中:', data)
    })

    board.on('curve:created', (data) => {
      console.log('曲线已创建:', data)
    })

    board.on('curve:selected', (data) => {
      console.log('曲线已选择:', data)
    })

    board.on('rect:created', (data) => {
      console.log('矩形已创建:', data)
    })

    board.on('rect:clicked', (data) => {
      console.log('矩形被点击:', data)
    })

    board.on('text:created', (data) => {
      console.log('文本已创建:', data)
    })

    board.on('text:clicked', (data) => {
      console.log('文字被点击:', data)
    })

    board.on('text:modified', (data) => {
      console.log('文字被修改:', data)
    })

    board.on('image:created', (data) => {
      console.log('图片已创建:', data)
    })

    board.on('image:clicked', (data) => {
      console.log('图片被点击:', data)
    })

    board.on('canvas:zoomed', (e) => {
      console.log('缩放倍率：', e)
    })

    function exportCanvas() {
      const json = board.exportToJSON()
      console.log('导出数据:', JSON.parse(json))
    }

    function handleJsonFileImport(event) {
      const file = event.target.files[0]
      if (!file) return

      const reader = new FileReader()
      reader.onload = function (e) {
        try {
          const json = e.target.result
          board.clear()
          board.importFromJSON(json).then(() => {
            console.log('JSON文件导入成功')
          }).catch((error) => {
            console.error('导入失败:', error)
            alert('导入失败: ' + error.message)
          })
        } catch (error) {
          console.error('解析JSON文件失败:', error)
          alert('解析JSON文件失败')
        }
      }
      reader.readAsText(file)
      event.target.value = ''
    }

    function createSampleImage() {
      const canvas = document.createElement('canvas')
      canvas.width = 50
      canvas.height = 50
      const ctx = canvas.getContext('2d')
      ctx.fillStyle = '#02a7f0'
      ctx.fillRect(0, 0, 50, 50)
      ctx.fillStyle = '#ffffff'
      ctx.font = '12px Arial'
      ctx.textAlign = 'center'
      ctx.textBaseline = 'middle'
      ctx.fillText('IMG', 25, 25)
      return canvas.toDataURL('image/png')
    }
    const sampleImageBase64 = createSampleImage()

    let textCounter = 1
    let lastCreatedTextId = null
    let lastCreatedImageId = null

    // 新增文字
    function addCustomText() {
      const text = board.addText({
        x: textCounter * 16,
        y: textCounter * 16,
        text: '测试文字 ' + textCounter,
        editable: false,
        fontSize: 12,
        // fill: 'red'
      })
      if (text && text.customData) {
        lastCreatedTextId = text.customData.drawId
      }
      textCounter++
    }

    // 新增图片
    async function addCustomImage() {
      const img = await board.addImage({
        x: 200,
        y: 200,
        width: 20,
        // src: '/demo/static/camera.png'
        base64: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAUCAYAAABmvqYOAAACsUlEQVR4AbRUW08TQRg9M7vbmy1YrFDk8sADJl5SNFpIGiDGRBISisToL9CE+KDRmPgi/gATY0z4A8ZnnohibCRCVC7aSCCioKigRNS2JNKyrbQdZ6YrgW4bXuhmzzfzne/M2dnZmaX+wTHdPzjOdhsnB8f7KQOJowQXA0tRApYogTf4rJMUjJTEnFGSpIyw0iwL4+bxWJTGI7+x29Bjv3TqrPDEnZ79yIdVVUycs5DOohXU2d2eBco/5grHtptl0vgbi2zjCiXZVBIbq9FCJRAoEUoYm4LpIiamIEEVECrmZ66mrNZZyqCM55eIosB2oC6fNuVU02CprDbxfI/PTHf4EvR10D/Ct+P1LNhEMhZZSSx9TccXP0P/8R2JhbkdoS9/g9ALbKwn5rnxM8Jot3iifKfJYPM9gF2JjY3+jLwcVqOvniM6EkJ0+PHOGH0Kqedj4nPvXvzJZnq435dNc9FJg64SVdVFX6LIWsra1rBFR22OtblgYPPcyJkLrQJ1WbHZY6IvoWpgslM8yDrX/Vc4vNVhECJpwW2ah7tOrFsrKkOClCAEsDmKPkA68DpIzkJ1lr3X3J5pOdYIuYqR2I/6Hmmu8hkjBcSsHC4wixVMUcH41pMtz8F5WTfEjtr6UEyJfjBS2VAZjTDV1fLR7fPfpKq2alCAWFOqApoFEKaqaG053hDZqmqGypqO3f3U2ZkyKNlQGbeEmcvnh1yNjdfs3tonfL+vgZ9CsCw0jnKrBhAA67lvZnHvm9xT3zDgbe+4EQ62LvHKtttkLqrzt64+cAdO91a2n+mDoqaRyWAjk0VCTwLpNMAPmd1bE6rq6L7jDjT3TpxtmRXj8lHQXIjengssTl/sue9qOt7mPOzrcx481G9raHzoPNJ0W/PWXdrb2nbhTbBlINx1quhP6B8AAAD//7KfP7kAAAAGSURBVAMAHm58isoK8SwAAAAASUVORK5CYII='
      })
      if (img && img.customData) {
        lastCreatedImageId = img.customData.drawId
      }
    }

    // 通过ID删除对象
    function deleteById(id) {
      const result = board.removeById(id)
      console.log('通过ID删除结果:', result, 'ID:', id)
      return result
    }

    // 列出所有自定义对象
    function listCustomObjects() {
      const objects = board.getCustomObjects()
      console.log('所有自定义对象:', objects)
      return objects
    }

    // 通过输入框ID修改文字
    function updateTextByInput() {
      const id = document.getElementById('textIdInput').value.trim()
      if (!id) {
        alert('请输入文字ID')
        return
      }
      const newText = prompt('请输入新的文字内容:')
      if (newText !== null) {
        const result = board.updateTextById(id, {
          text: newText,
          fill: '#ff0000'
        })
        if (result) {
          console.log('通过ID修改文字成功:', id)
        } else {
          alert('未找到该ID的文字对象')
        }
      }
    }

    // 通过输入框ID旋转图片
    function rotateImageByInput() {
      const id = document.getElementById('imageIdInput').value.trim()
      if (!id) {
        alert('请输入图片ID')
        return
      }
      const obj = board.getObjectById(id)
      if (obj) {
        const currentAngle = obj.angle || 0
        const result = board.updateImageById(id, {
          angle: currentAngle + 45
        })
        console.log('通过ID旋转图片成功:', id, '当前角度:', currentAngle + 45)
      } else {
        alert('未找到该ID的图片对象')
      }
    }

    // 通过输入框ID删除对象
    function deleteByInput() {
      const id = document.getElementById('deleteIdInput').value.trim()
      if (!id) {
        alert('请输入要删除的ID')
        return
      }
      const result = board.removeById(id)
      if (result) {
        console.log('通过ID删除成功:', id)
        document.getElementById('deleteIdInput').value = ''
      } else {
        alert('未找到该ID的对象')
      }
    }

    // 背景图相关函数
    function setBackgroundImage() {
      const source = document.getElementById('bgImageInput').value.trim()
      const scaleMode = document.getElementById('bgScaleMode').value
      if (!source) {
        alert('请输入图片URL或Base64')
        return
      }
      board.setBackgroundImage({
        source: source,
        scaleMode: scaleMode,
        opacity: 1
      }).then(() => {
        console.log('背景图已设置')
      })
    }

    function clearBackgroundImage() {
      board.clearBackgroundImage()
      console.log('背景图已清除')
    }

    // 手动上传本地图片作为背景
    function handleBgFileSelect(event) {
      const file = event.target.files[0]
      if (!file) return

      const reader = new FileReader()
      reader.onload = function (e) {
        const base64 = e.target.result
        const scaleMode = document.getElementById('bgScaleMode').value
        board.setBackgroundImage({
          source: base64,
          scaleMode: scaleMode,
          opacity: 1
        }).then(() => {
          console.log('本地背景图已设置')
        })
      }
      reader.readAsDataURL(file)
      event.target.value = ''
    }

    board.on('backgroundImage:set', (data) => {
      console.log('背景图已设置:', data)
    })

    board.on('backgroundImage:cleared', () => {
      console.log('背景图已清除')
    })

    board.on('backgroundImage:error', (data) => {
      console.error('背景图加载失败:', data)
    })

    // 人员追踪示例
    let tracker = board.createPersonTracker()

    // 创建单人员示例
    function createSinglePerson() {
      let personId = 0
      let timer = null
      timer = setInterval(() => {
        if (personId >= 3) {
          clearInterval(timer)
          return
        }
        personId++
        const person = {
          id: `person-${personId}`,
          name: `人员${personId}`,
          x: 100 + Math.random() * 800,
          y: 100 + Math.random() * 400,
          status: personId % 2 === 0 ? 'fainted' : 'normal',
          lineColor: `hsl(${Math.random() * 360}, 70%, 50%)`
        }
        tracker.createSinglePerson(person)
        console.log('单个人员已创建:', person)
      }, 2000)
    }

    const mockPersons = [
      { id: 'p1', name: '张三', x: 100, y: 100, lineColor: '#ff0000', status: 'normal' },
      { id: 'p2', name: '李四', x: 200, y: 150, lineColor: '#00ff00', status: 'fainted' },
      { id: 'p3', name: '王五', x: 300, y: 200, lineColor: '#0000ff', status: 'normal' }
    ]
    // 创建多人员示例
    function createMultiplePersons() {
      tracker.createMultiplePersons(mockPersons)
      console.log('人员已初始化:', mockPersons)
    }

    // 更新多人位置示例
    function updatePersonPositions() {
      mockPersons.forEach(p => {
        p.x += Math.random() * 50 - 25
        p.y += Math.random() * 50 - 25
        p.x = Math.max(50, Math.min(p.x, 700))
        p.y = Math.max(50, Math.min(p.y, 500))
      })
      tracker.createMultiplePersons(mockPersons)
      console.log('位置已更新:', mockPersons)
    }

    // 显示人员轨迹示例
    function showTraceDemo(pathType) {
      tracker.clearAll()
      tracker = board.createPersonTracker({
        animationSpeed: 0.1,
        pathType: pathType
      })
      const traces = [
        { x: 100, y: 300 },
        { x: 200, y: 250 },
        { x: 350, y: 280 },
        { x: 450, y: 200 },
        { x: 550, y: 250 },
        { x: 650, y: 300 }
      ]
      tracker.showTrace('t1', {
        id: 't1',
        name: '巡检员',
        x: traces[0].x,
        y: traces[0].y,
        lineColor: '#ff6600'
      }, traces)
      console.log('轨迹动画已启动, 模式:', pathType)
    }

    function clearPersons() {
      tracker.clearAll()
      console.log('人员已清除')
    }

    board.on('person:updated', (data) => {
      console.log('人员更新:', data)
    })

    board.on('trace:shown', (data) => {
      console.log('轨迹显示事件:', data)
    })

    board.on('person:click', (data) => {
      console.log('人员点击事件:', data)
    })

    console.log('PaintBoard 已初始化:', board)
  </script>
</body>

</html>